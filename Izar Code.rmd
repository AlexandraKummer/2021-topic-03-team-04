---
title: "Izar Code"
author: "Izar"
date: "1 5 2021"
output: html_document
---

#this code turns out two dfs that have the ratio of the difference between the maximum and minimum values and their mean in a set
# of 3 repititions in a fraction orderd by protein by fraction this will help us analyse the data nd see which
# threshhold we want to set for eliminating points of data or merely selecting points of data
# furter steps include: calculating the mean and sd of the ratios
#                       evaluating the impact of NAs
#                       selecting protein x fraction where data is significant
#                       removing insignificant data from set

Loading Data and Packages

```{r}
library(ggplot2)
library(tidyverse)
library(dplyr)

#loading data into Raw_Data dataframe
Raw_Data<- read.table("c://Data_Analysis//RDeeP_A549_NS.csv", header=TRUE, row.names=1, sep = ";")

#function for ratio of max-min to mean allows setting of univeral limit
min_max_mean_func <- function(x){
  (max(x)-min(x))/mean(x)
}
```
ignore
```{r}

#RNAse Factor df         
#RNAse_frac_df <- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data)) #creating a dataframe to save results too

#n <-2 # for RNAse n = 2 for ctrl n =1 corresponding to position in dataframe
#while (n < 150){ # this will iterate trough all the fractions

 #   temp_df <- data.frame(Raw_Data[,n],Raw_Data[,n+2],Raw_Data[,n+4])  # a temporary df for sotring the 3 reps of each fraction
    
  #  Output_df <-data.frame(apply(temp_df,1,min_max_mean_func))     #the function for comparing (max-min)/mean is applied across the rows apply(...,1,..) for rows 2 for cols
    
   # RNAse_frac_df <- cbind(RNAse_frac_df,Output_df)           #each run through adds a colum to RNAse_frac_df, we end with 26 cols
    
  #  n <- n + 6     # the counter is increased to select the next fraction
#}
#colnames(RNAse_frac_df) = c(paste("frac",0:25, sep = "_"))

#RNAse_frac_df = RNAse_frac_df[,-1] #this code deletes the unnessecary first null colum
```
ignore
```{r}
#
#Control Factor df
#ctrl_frac_df <- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
#n <-1
#while (n < 150){
#    temp_df <- data.frame(Raw_Data[,n],Raw_Data[,n+2],Raw_Data[,n+4]) 
#    Output_df <-data.frame(apply(temp_df,1,min_max_mean_func))
#    ctrl_frac_df <- cbind(ctrl_frac_df,Output_df)
#    n <- n + 6
#}
#colnames(ctrl_frac_df) = c(paste("frac",0:25, sep = "_"))

#ctrl_frac_df = ctrl_frac_df[,-1] #this code deletes the unnessecary first null colum
```



Normalizing Protein data x/ntot   ##results in Norm_Data_df
```{r}
#generates 
T_P_S_df <- data.frame(Total_Protein_Sum)
T_P_S_vec <-c(T_P_S_df[1,],T_P_S_df[4,],T_P_S_df[2,],T_P_S_df[5,],T_P_S_df[3,],T_P_S_df[6,])
T_P_S_vec_div_func <- function(x){
  x/T_P_S_vec
}
Norm_Data_df <- t(data.frame(apply(Raw_Data,1,T_P_S_vec_div_func)))


```

Creating seperate RNAse and Ctrl dfs    ##results in norm_RNAse & norm_Ctrl
```{r}
# Normailized RNAse only
RNAse_select_vec <- c(seq(from =2, to = 150, by = 2))
norm_RNAse <-data.frame(Norm_Data_df[,RNAse_select_vec])

#Normalized Ctrl only
Ctrl_select_vec <- seq(from =1, to = 150, by = 2)
norm_Ctrl <- data.frame(Norm_Data_df[,Ctrl_select_vec])
```


*(work in progress)
Trying to apply LOF/lof   ##results in NoOut_norm_RNAse_df & NoOut_norm_Ctrl_df
```{r}
library(DDoutlier)
library(dbscan)
library(psych)



#issues with applying DDoutlier::LOF and dbscan::lof 
' data.frame(apply(data.frame(norm_RNAse[,1],norm_RNAse[,2],norm_RNAse[,3]),1,lof))
Error in FUN(newX[, i], ...) : x needs to be a matrix or a dist object!
 data.frame(apply(data.frame(norm_RNAse[,1],norm_RNAse[,2],norm_RNAse[,3]),1,LOF))
Error in if (k >= n || k < 1) { : missing value where TRUE/FALSE needed'

#creating empty dataframe to store results
NoOut_norm_RNAse_df <- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
'
step 1 seperate the Raw Data into RNAse and Ctrl each with 3680x75 now we have rep 1,2,3 next to each other
step 2 apply(temp_vec,1,LOF_func) to a temp vec consisting of rep n,n+1,n+2
step 3 save into empty df
'
LOF_func <-function(x){ #creating function usable in apply
return(lof(x,2))}
n <-1

while (n < 75){
    temp_df <- as.matrix(norm_RNAse[,n],norm_RNAse[,n+1],norm_RNAse[,n+2])
    Output_df <-t(data.frame(apply(temp_df,1,LOF_func)))
    NoOut_norm_RNAse_df <- cbind(NoOut_norm_RNAse_df,Output_df)
    n <- n + 3
}
NoOut_norm_RNAse_df = NoOut_norm_RNAse_df[,-1]
colnames(NoOut_norm_RNAse_df) = c(colnames(norm_RNAse))







#different approach

lof_apply_func <- function(x){
  
  Output_df <- data.frame(matrix(nrow = nrow(x), ncol=0),row.names = row.names(x))
        n <-1
        while (n < 75){
        temp_df <- data.frame(x[,n],x[,n+1],x[,n+2])
          
          for(i in length(row.names(x))){ 
            u <- t(data.frame(temp_df[i,]))
            temp_vec <- as.vector(LOF(u,2))
            temp_Output_df <- rbind(t(data.frame(temp_vec)))
          }
   
        Output_df <- cbind(Output_df,temp_Output_df)
         n <- n + 3
        }
        return(Output_df)
}


'Manual run for error finding'


temp_df <- data.frame(norm_RNAse[,1],norm_RNAse[,2],norm_RNAse[,3])
u <- t(data.frame(temp_df[1,]))
            temp_vec <- c(LOF(u,2)) 
            temp_Output_df <- rbind(t(data.frame(temp_vec)))
            
            
            

# this works ??? all i did was replace all the x with norm_RNAse shouldnt the function do the same thing ?
  lof_RNAse <- data.frame(matrix(nrow = nrow(norm_RNAse), ncol=0),row.names = row.names(norm_RNAse))
        n <-1
        while (n < 75){
        temp_df <- data.frame(norm_RNAse[,n],norm_RNAse[,n+1],norm_RNAse[,n+2])
          
          for(i in length(row.names(norm_RNAse))){ 
            u <- t(data.frame(temp_df[i,]))
            temp_vec <- as.vector(LOF(u,2))
            temp_Output_df <- rbind(t(data.frame(temp_vec)))
          }
   
        lof_RNAse<- cbind(lof_RNAse,temp_Output_df)
         n <- n + 3
        }



```
*not yet necessary bc lof does not work yet
Removing Values based on if Outlier or not ##results in clean_RNAse_df & clean_Ctrl_df'
```{r}
#modifying the LO factor df  to remove any value above  (arbitrary) 1.5, setting all values < 1.5 = 1 and all values >1.5 = 0
data_clean_func <- function(x,z,treshhold){ # x = data to clean # z = LOF output df RNASe or Ctrl #threshhold can be played around with for signifacance of data
  treshhold_clean_func <- function(y){
    if (y >= treshhold){
      y <- 0
    }else{
      y <- 1
    }
  }
  
  binary_removal_df <- data.frame(apply(z,1,treshhold_clean_func))
  
  x*binary_removal_df
  
}
# i realized we might want to set 0 to NA before doing data cleaning think about it later
clean_RNAse_df <- data_clean_func(norm_RNAse,LOF_RNAse,1.5)
clean_RNAse_df[clean_RNAse_df == 0] <- NA
clean_Ctrl_df <- data_clean_func(norm_Ctrl,LOF_Ctrl,1.5)
clean_Ctrl_df[clean_Ctrl_df == 0] <- NA


```
*not yet necessary bc lof does not work yet 
mean of RNAse and Ctrl reps  ## results in clean_mean_RNAse_df & clean_mean_Ctrl_df
```{r}
# creating mean_clean_RNAse_df 3860x25, normalized and cleaned of outlieres
mean_clean_RNAse_df<- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
n<-2
while (n < 75){
    temp_df <- data.frame(clean_RNAse_df[,n],clean_RNAse_df[,n+1],clean_RNAse_df[,n+2])
    Output_df <-data.frame(apply(temp_df,1,mean))
    mean_clean_RNAse_df<- cbind(mean_clean_RNAse_df,Output_df)
    n <- n + 3
}
colnames(mean_clean_RNAse_df) = c(paste("RNAse","frac",0:25, sep = "_"))
mean_clean_RNAse_df = mean_clean_RNAse_df[,-1]


# creating mean_clean_Ctrl_df 3860x25, normalized and cleaned of outlieres
mean_clean_Ctrl_df<- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
n<-1
while (n < 75){
    temp_df <- data.frame(clean_Ctrl_df[,n],clean_Ctrl_df[,n+1],clean_Ctrl_df[,n+2])
    Output_df <-data.frame(apply(temp_df,1,mean))
    mean_clean_Ctrl_df<- cbind(mean_clean_Ctrl_df,Output_df)
    n <- n + 3
}
colnames(mean_clean_Ctrl_df) = c(paste("Ctrl","frac",0:25, sep = "_"))
mean_clean_Ctrl_df = mean_clean_Ctrl_df[,-1]
```



*works
Creating df with median method ##results in 3680 RNAse_median_df & Ctrl_median_df
Wird angenommen, dass der Median eine gute Methode für n=3 stichproben ist, die robust gegenüber OUtlieren ist."https://wis.kuleuven.be/statdatascience/robust/papers/2002/rousseeuwverboven-robustestimationinverysmallsampl.pdf"
```{r}
RNAse_median_df <- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
n <-1
while (n < 75){
    temp_df <- data.frame(norm_RNAse[,n],norm_RNAse[,n+1],norm_RNAse[,n+2])
    Output_df <-data.frame(apply(temp_df,1,median))
    RNAse_median_df<- cbind(RNAse_median_df,Output_df)
    n <- n + 3
}
colnames(RNAse_median_df) = c(paste("frac",0:25, sep = "_"))
RNAse_median_df = RNAse_median_df[,-1]



Ctrl_median_df <- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
n <-1
while (n < 75){
    temp_df <- data.frame(norm_Ctrl[,n],norm_Ctrl[,n+1],norm_Ctrl[,n+2])
    Output_df <-data.frame(apply(temp_df,1,median))
    Ctrl_median_df<- cbind(Ctrl_median_df,Output_df)
    n <- n + 3
}
colnames(Ctrl_median_df) = c(paste("frac",0:25, sep = "_"))
Ctrl_median_df = Ctrl_median_df[,-1]



```


*works
now by arithmetic mean ##results in RNAse_mean_df & Ctrl_mean_df
```{r}
RNAse_mean_df <- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
n <-1
while (n < 75){
    temp_df <- data.frame(norm_RNAse[,n],norm_RNAse[,n+1],norm_RNAse[,n+2])
    Output_df <-data.frame(apply(temp_df,1,mean))
    RNAse_mean_df<- cbind(RNAse_mean_df,Output_df)
    n <- n + 3
}
colnames(RNAse_mean_df) = c(paste("frac",0:25, sep = "_"))
RNAse_mean_df = RNAse_mean_df[,-1]



Ctrl_mean_df <- data.frame(matrix(nrow = 3680, ncol=1),row.names = row.names(Raw_Data))
n <-1
while (n < 75){
    temp_df <- data.frame(norm_Ctrl[,n],norm_Ctrl[,n+1],norm_Ctrl[,n+2])
    Output_df <-data.frame(apply(temp_df,1,mean))
    Ctrl_mean_df<- cbind(Ctrl_mean_df,Output_df)
    n <- n + 3
}
colnames(Ctrl_mean_df) = c(paste("frac",0:25, sep = "_"))
Ctrl_mean_df = Ctrl_mean_df[,-1]
```


*(work in progresss)
Wilcox Comparison tests between RNAse and Ctrl ##results in wilcox_pval_df
```{r}
library(rstatix)
library(stats)
'NONE OF THIS WORKS the output of the wilcox function is a list, we need to access the "statistic value" or the "p.value"'

#creating function to use with our cleaned data for applying wilcox
wilcox_apply_func <-function(x,y){
    output_vec <- vector()
    i <-1
    while(i <= nrow(x)) {
    #taking rows and making them into vectors usable by the wicoxsonfunc
    u <-x[i,]
    v <-y[i,]
    
    #applyig wilcox to each set of paired control and RNASe vectors
    wilcox_val <- wilcox.test(u,v, 
                              alternative = "two.sided",
                              mu = 0,
                              paired = FALSE,
                              conf.level = 0.95)
    #generating an output vector to store the outputs 
    append(output_vec, wilcox_val$p.value, after = length(output_vec))   #the $p.value should access the list
    i <-i+1
    }
    #saving the output vector as a dataframe with  dim 3680x1 from output_vec
    wilcox_scores_df <-data.frame(output_vec, row.names = row.names(x))
    colnames(wilcox_scores_df) <- c("Wilcox_score")
    
}

median_wilcox <- wilcox_apply_func(RNAse_median_df,Ctrl_median_df)

mean_wilcox <- wilcox_apply_func(RNAse_mean_df,Ctrl_mean_df)



```


*(work in progress)
focusing stat test on changes in fractions 19-25
```{r}


```